version: '3.8'

services:
  cdn-checker:
    # Use image from GitHub Container Registry
    image: ghcr.io/nedkohristov/cdn-check:latest
    container_name: cdn-checker
    ports:
      # Bind to localhost only for security when using Nginx proxy
      - "127.0.0.1:5000:5000"
      # Or expose publicly (not recommended without SSL):
      # - "5000:5000"
    restart: unless-stopped
    environment:
      # Number of Gunicorn workers: (2 Ã— CPU_cores) + 1
      - WORKERS=4
    labels:
      # Enable Watchtower auto-update
      - "com.centurylinklabs.watchtower.enable=true"
    # Optional: resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    ports:
      # Expose HTTP API on localhost only for security
      - "127.0.0.1:8080:8080"
    volumes:
      # Mount Docker socket to manage containers
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Check for updates every 5 minutes (300 seconds) - fallback for missed webhooks
      - WATCHTOWER_POLL_INTERVAL=300
      # Only update containers with the watchtower label
      - WATCHTOWER_LABEL_ENABLE=true
      # Clean up old images after updating
      - WATCHTOWER_CLEANUP=true
      # Include stopped containers
      - WATCHTOWER_INCLUDE_STOPPED=true
      # HTTP API token for webhook authentication
      - WATCHTOWER_HTTP_API_TOKEN=${WATCHTOWER_TOKEN}
      # Enable notifications (optional)
      # - WATCHTOWER_NOTIFICATIONS=shoutrrr
      # - WATCHTOWER_NOTIFICATION_URL=telegram://token@telegram?channels=channel-1
    command: --debug --http-api-update
