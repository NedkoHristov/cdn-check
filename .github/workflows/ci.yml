name: CI - Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      run_security_scan:
        description: 'Run security scan'
        required: false
        default: false
        type: boolean

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt flake8 black

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with black
        run: |
          black --check --diff . || true

      - name: Test Python import
        run: |
          python -c "from app import app, check_cdn, validate_url; print('✓ Imports successful')"

      - name: Run basic functionality tests
        run: |
          python -c "
          from app import validate_url, CDNS
          
          # Test URL validation
          url, error = validate_url('example.com')
          assert url is not None, 'URL validation failed'
          assert error is None, 'Unexpected error in validation'
          print('✓ URL validation working')
          
          # Test CDN signatures loaded
          assert len(CDNS) > 0, 'No CDN signatures loaded'
          print(f'✓ {len(CDNS)} CDN signatures loaded')
          
          # Test SiteGround CDN exists
          assert 'SiteGround CDN' in CDNS, 'SiteGround CDN not found'
          print('✓ SiteGround CDN signature present')
          
          print('All basic tests passed!')
          "

  build-docker:
    needs: lint-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get build timestamp
        id: timestamp
        run: echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Build Docker image (test)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: cdn-checker:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            APP_VERSION=ci-${{ github.sha }}
            BUILD_TIME=${{ steps.timestamp.outputs.time }}

      - name: Show build summary
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "✅ Docker image built successfully" >> $GITHUB_STEP_SUMMARY

  security-scan:
    needs: build-docker
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      security-events: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      # 1. Gitleaks - Secret scanning
      - name: Run Gitleaks secret scanner
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      # 2. Semgrep - SAST code scanning
      - name: Run Semgrep security scan
        uses: semgrep/semgrep-action@v1
        with:
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
        env:
          SEMGREP_RULES: auto

      # 3. Trivy - Filesystem scanning (dependencies)
      - name: Run Trivy filesystem scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'

      - name: Upload Trivy filesystem results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem-scan'
