name: CI - Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with black
        run: |
          black --check --diff . || true

      - name: Test Python import
        run: |
          python -c "from app import app, check_cdn, validate_url; print('âœ“ Imports successful')"

      - name: Run basic functionality tests
        run: |
          python -c "
          from app import validate_url, CDNS
          
          # Test URL validation
          url, error = validate_url('example.com')
          assert url is not None, 'URL validation failed'
          assert error is None, 'Unexpected error in validation'
          print('âœ“ URL validation working')
          
          # Test CDN signatures loaded
          assert len(CDNS) > 0, 'No CDN signatures loaded'
          print(f'âœ“ {len(CDNS)} CDN signatures loaded')
          
          # Test SiteGround CDN exists
          assert 'SiteGround CDN' in CDNS, 'SiteGround CDN not found'
          print('âœ“ SiteGround CDN signature present')
          
          print('All basic tests passed!')
          "

  build-docker:
    needs: lint-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: cdn-checker:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Test Docker image
        run: |
          # Start container
          docker run -d -p 5000:5000 --name cdn-checker-test cdn-checker:test
          
          # Wait for startup
          echo "Waiting for container to start..."
          sleep 15
          
          # Test health
          echo "Testing application..."
          curl -f http://localhost:5000/ || exit 1
          
          # Show logs
          echo "Container logs:"
          docker logs cdn-checker-test
          
          # Get image size
          IMAGE_SIZE=$(docker images cdn-checker:test --format "{{.Size}}")
          echo "Image size: $IMAGE_SIZE"
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Docker image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Image size: **$IMAGE_SIZE**" >> $GITHUB_STEP_SUMMARY
          
          # Cleanup
          docker stop cdn-checker-test
          docker rm cdn-checker-test

      - name: Analyze image layers
        run: |
          echo "## Docker Image Layers" >> $GITHUB_STEP_SUMMARY
          docker history cdn-checker:test --no-trunc --format "table {{.CreatedBy}}\t{{.Size}}" >> $GITHUB_STEP_SUMMARY
